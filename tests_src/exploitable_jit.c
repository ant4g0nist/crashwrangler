
#include <sys/mman.h>
#include <unistd.h>
#include <err.h>
#include <mach/vm_param.h>
#include <string.h>
#include <stdint.h>
#include <pthread.h>

#if !defined(__arm64__)
void nullderef() {
    char * ptr = 0;
    ptr[0] = 0;
}
#endif

int main() {
    //currently there's no enforcement of W^X if the program explicitly maps in a page with W|X perms.
    //create an executable buffer with code that does a null deref.  This should be considered exploitable
    //if the CW_EXPLOITABLE_JIT environment variable is set
    //since it's running outside of a known function.
#if defined(__arm64__)
    // arm64 macOS enforces W^X: use MAP_JIT and pthread_jit_write_protect_np
    char * buf = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON | MAP_PRIVATE | MAP_JIT, -1, 0);
    if (buf == MAP_FAILED) {
        err(-1, "mmap");
    }
    pthread_jit_write_protect_np(0);
    // mov x0, #0; strb wzr, [x0] â€” null deref write
    uint32_t arm64_code[] = { 0xd2800000, 0x3900001f };
    memcpy(buf, arm64_code, sizeof(arm64_code));
    pthread_jit_write_protect_np(1);
#else
    char * buf = mmap(NULL, PAGE_SIZE, PROT_READ | PROT_WRITE | PROT_EXEC, MAP_ANON | MAP_PRIVATE, -1, 0);
    if (buf == MAP_FAILED) {
        err(-1, "mmap");
    }
    memcpy(buf, nullderef, PAGE_SIZE);
#endif
    void (*fp)() = (void(*)())buf;
    (*fp)();
}
